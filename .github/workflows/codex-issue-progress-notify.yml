name: codex-issue-progress-notify

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  notify:
    if: |
      github.event.label.name == 'spec-done' ||
      github.event.label.name == 'plan-done' ||
      github.event.label.name == 'tasks-done'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Build message payload
        id: payload
        uses: actions/github-script@v7
        with:
          script: |
            const label = context.payload.label.name
            const issue = context.payload.issue
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`
            const issueUrl = `${repoUrl}/issues/${issue.number}`

            const phaseMap = {
              "spec-done": "Spec phase completed",
              "plan-done": "Plan phase completed",
              "tasks-done": "Tasks phase completed",
            }

            const phaseText = phaseMap[label] ?? label
            const text = [
              "Codex issue progress update",
              `Repo: ${context.repo.owner}/${context.repo.repo}`,
              `Issue: #${issue.number} ${issue.title}`,
              `Phase: ${phaseText}`,
              `Label: ${label}`,
              `Link: ${issueUrl}`,
            ].join("\n")

            core.setOutput("phase_label", label)
            core.setOutput("phase_text", phaseText)
            core.setOutput("issue_url", issueUrl)
            core.setOutput("tg_text", text)

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TG_TEXT: ${{ steps.payload.outputs.tg_text }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID is not set. Skipping Telegram."
            exit 0
          fi

          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${TG_TEXT}" \
            -d "disable_web_page_preview=true"

      - name: Comment on issue
        uses: actions/github-script@v7
        env:
          PHASE_LABEL: ${{ steps.payload.outputs.phase_label }}
          PHASE_TEXT: ${{ steps.payload.outputs.phase_text }}
        with:
          script: |
            const body = [
              "Codex progress update",
              "",
              `- Status: ${process.env.PHASE_TEXT}`,
              `- Label: \`${process.env.PHASE_LABEL}\``,
              "- Notification: Telegram + GitHub issue comment",
            ].join("\n")

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body,
            })

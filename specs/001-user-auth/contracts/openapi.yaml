openapi: 3.1.0
info:
  title: User Authentication API
  version: 1.0.0
  description: |
    RESTful API for user authentication, session management, and profile operations.
    
    **Feature**: 001-user-auth  
    **Specification**: [spec.md](../spec.md)  
    **Data Model**: [data-model.md](../data-model.md)
    
    ## Authentication
    
    All endpoints except `/auth/signup` and `/auth/login` require authentication via HTTP-only cookie containing JWT token.
    
    ## Security
    
    - All endpoints require HTTPS
    - Passwords are hashed with bcrypt (work factor 12)
    - Sessions expire after 30 days of inactivity
    - Rate limiting: 5 failed login attempts â†’ 15 minute lockout

  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: https://api.example.com/v1
    description: Production server
  - url: https://api.staging.example.com/v1
    description: Staging server
  - url: http://localhost:8000/v1
    description: Local development server

tags:
  - name: Authentication
    description: User signup, login, logout operations
  - name: Profile
    description: User profile management

paths:
  /auth/signup:
    post:
      tags:
        - Authentication
      summary: Create a new user account
      description: |
        Register a new user with email, password, and display name.
        Automatically logs in the user upon successful registration.
        
        **Functional Requirements**: FR-001, FR-002, FR-003, FR-004, FR-005
        **User Story**: Story 1 - Signup
        **Success Criteria**: SC-001, SC-006
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
            examples:
              validSignup:
                summary: Valid signup request
                value:
                  email: user@example.com
                  password: SecureP@ss123
                  display_name: John Doe
              invalidEmail:
                summary: Invalid email format
                value:
                  email: notanemail
                  password: SecureP@ss123
                  display_name: John Doe
              weakPassword:
                summary: Weak password (too short)
                value:
                  email: user@example.com
                  password: short
                  display_name: John Doe
      responses:
        '201':
          description: User created and logged in successfully
          headers:
            Set-Cookie:
              description: Session JWT token (HTTP-only, Secure, SameSite=Strict)
              schema:
                type: string
                example: session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=2592000; Path=/
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
              example:
                id: 123e4567-e89b-12d3-a456-426614174000
                email: user@example.com
                display_name: John Doe
                created_at: '2026-02-05T12:00:00Z'
                last_login_at: '2026-02-05T12:00:00Z'
        '400':
          description: Invalid input (validation errors)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error: Validation Error
                    message: Invalid email address format
                    details:
                      - field: email
                        message: Must be a valid email address (e.g., user@example.com)
                weakPassword:
                  summary: Weak password
                  value:
                    error: Validation Error
                    message: Password does not meet security requirements
                    details:
                      - field: password
                        message: Password must be at least 8 characters with 1 digit and 1 special character
                emptyDisplayName:
                  summary: Empty display name
                  value:
                    error: Validation Error
                    message: Display name cannot be empty
                    details:
                      - field: display_name
                        message: Display name must be between 1 and 100 characters
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Conflict
                message: This email is already in use
                details:
                  - field: email
                    message: An account with this email already exists
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Authenticate user and create session
      description: |
        Log in with email and password. Returns user data and sets session cookie.
        
        **Functional Requirements**: FR-006, FR-007, FR-008
        **User Story**: Story 2 - Login
        **Success Criteria**: SC-002
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: user@example.com
              password: SecureP@ss123
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              description: Session JWT token (HTTP-only, Secure, SameSite=Strict)
              schema:
                type: string
                example: session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=2592000; Path=/
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
              example:
                id: 123e4567-e89b-12d3-a456-426614174000
                email: user@example.com
                display_name: John Doe
                created_at: '2026-01-15T10:30:00Z'
                last_login_at: '2026-02-05T12:00:00Z'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Unauthorized
                message: Email or password is incorrect
                details: []
        '429':
          description: Too many login attempts (rate limited)
          headers:
            Retry-After:
              description: Seconds until lockout expires
              schema:
                type: integer
                example: 900
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Too Many Requests
                message: Too many failed login attempts. Please try again in 15 minutes.
                details:
                  - field: _global
                    message: Account temporarily locked due to multiple failed attempts
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: End current session
      description: |
        Log out the current user by invalidating their session.
        
        **Functional Requirements**: FR-010
        **User Story**: Story 2 - Logout
      operationId: logout
      security:
        - cookieAuth: []
      responses:
        '204':
          description: Logout successful (no content)
          headers:
            Set-Cookie:
              description: Clear session cookie
              schema:
                type: string
                example: session=; HttpOnly; Secure; SameSite=Strict; Max-Age=0; Path=/
        '401':
          description: Not authenticated (no valid session)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Unauthorized
                message: No active session found
                details: []
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current authenticated user
      description: |
        Retrieve the profile of the currently authenticated user.
        Used to check if session is still valid and get user info.
        
        **Functional Requirements**: FR-012
      operationId: getCurrentUser
      security:
        - cookieAuth: []
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
              example:
                id: 123e4567-e89b-12d3-a456-426614174000
                email: user@example.com
                display_name: John Doe
                created_at: '2026-01-15T10:30:00Z'
                last_login_at: '2026-02-05T12:00:00Z'
        '401':
          description: Not authenticated or session expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Unauthorized
                message: Session expired. Please log in again.
                details: []
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /profile:
    get:
      tags:
        - Profile
      summary: Get user profile
      description: |
        Retrieve detailed profile information for the authenticated user.
        
        **Functional Requirements**: FR-012
        **User Story**: Story 3 - Profile View
      operationId: getProfile
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
              example:
                id: 123e4567-e89b-12d3-a456-426614174000
                email: user@example.com
                display_name: John Doe
                created_at: '2026-01-15T10:30:00Z'
                last_login_at: '2026-02-05T12:00:00Z'
                active_sessions_count: 2
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags:
        - Profile
      summary: Update user profile
      description: |
        Update the authenticated user's display name.
        Email cannot be changed (primary identifier).
        
        **Functional Requirements**: FR-013, FR-014, FR-015, FR-016
        **User Story**: Story 3 - Profile Update
        **Success Criteria**: SC-004
      operationId: updateProfile
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
            examples:
              validUpdate:
                summary: Update display name
                value:
                  display_name: Jane Smith
              unicodeDisplayName:
                summary: Display name with emoji
                value:
                  display_name: 'John Doe ðŸš€'
              invalidEmpty:
                summary: Invalid - empty display name
                value:
                  display_name: ''
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
              example:
                id: 123e4567-e89b-12d3-a456-426614174000
                email: user@example.com
                display_name: Jane Smith
                created_at: '2026-01-15T10:30:00Z'
                last_login_at: '2026-02-05T12:00:00Z'
                active_sessions_count: 2
        '400':
          description: Invalid input (validation errors)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                emptyDisplayName:
                  summary: Empty display name
                  value:
                    error: Validation Error
                    message: Display name cannot be empty
                    details:
                      - field: display_name
                        message: Display name must be between 1 and 100 characters
                tooLong:
                  summary: Display name too long
                  value:
                    error: Validation Error
                    message: Display name exceeds maximum length
                    details:
                      - field: display_name
                        message: Display name must be between 1 and 100 characters
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
      description: |
        JWT token stored in HTTP-only cookie.
        Automatically sent by browser with each request.

  schemas:
    SignupRequest:
      type: object
      required:
        - email
        - password
        - display_name
      properties:
        email:
          type: string
          format: email
          maxLength: 320
          description: User's email address (RFC 5321 compliant)
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          description: Password (min 8 chars, 1 digit, 1 special char)
          example: SecureP@ss123
        display_name:
          type: string
          minLength: 1
          maxLength: 100
          description: User's display name (supports Unicode)
          example: John Doe

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        password:
          type: string
          format: password
          description: User's password
          example: SecureP@ss123

    UpdateProfileRequest:
      type: object
      properties:
        display_name:
          type: string
          minLength: 1
          maxLength: 100
          description: New display name (supports Unicode)
          example: Jane Smith

    UserResponse:
      type: object
      required:
        - id
        - email
        - display_name
        - created_at
        - last_login_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
          example: 123e4567-e89b-12d3-a456-426614174000
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        display_name:
          type: string
          description: User's display name
          example: John Doe
        created_at:
          type: string
          format: date-time
          description: Account creation timestamp (ISO 8601, UTC)
          example: '2026-01-15T10:30:00Z'
        last_login_at:
          type: string
          format: date-time
          nullable: true
          description: Last successful login timestamp (ISO 8601, UTC)
          example: '2026-02-05T12:00:00Z'

    ProfileResponse:
      allOf:
        - $ref: '#/components/schemas/UserResponse'
        - type: object
          properties:
            active_sessions_count:
              type: integer
              description: Number of active sessions for this user
              example: 2
              minimum: 0

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type (e.g., "Validation Error", "Unauthorized")
          example: Validation Error
        message:
          type: string
          description: Human-readable error message
          example: Invalid email address format
        details:
          type: array
          description: Detailed validation errors (optional)
          items:
            type: object
            required:
              - field
              - message
            properties:
              field:
                type: string
                description: Field name that caused the error
                example: email
              message:
                type: string
                description: Specific error message for this field
                example: Must be a valid email address

  responses:
    UnauthorizedError:
      description: Authentication required or session expired
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Unauthorized
            message: Session expired. Please log in again.
            details: []

    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Validation Error
            message: Invalid input data
            details:
              - field: email
                message: Must be a valid email address

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Internal Server Error
            message: An unexpected error occurred. Please try again later.
            details: []

security:
  - cookieAuth: []

# Feature Specification: 이메일 기반 회원가입 및 회원관리

**Feature Branch**: `001-email-auth-user-management`  
**Created**: 2026-02-09  
**Status**: Draft  
**Input**: User description: "이메일 기반 회원가입 및 회원관리 구현"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 이메일 회원가입 (Priority: P1)

신규 사용자가 이메일 주소와 비밀번호를 입력하여 계정을 생성하고, 이메일 인증을 통해 계정을 활성화합니다.

**Why this priority**: 이메일 회원가입은 사용자 온보딩의 가장 기본적인 기능으로, 이 기능 없이는 다른 모든 사용자 관리 기능이 무의미합니다. 가장 높은 우선순위로 독립적으로 테스트 가능한 MVP입니다.

**Independent Test**: 회원가입 폼에서 이메일과 비밀번호를 입력하고 제출하면, 데이터베이스에 사용자가 생성되고 이메일 인증 링크가 발송됩니다. 인증 링크 클릭 시 계정이 활성화되어 로그인이 가능해집니다.

**Acceptance Scenarios**:

1. **Given** 사용자가 회원가입 페이지에 접속, **When** 유효한 이메일(`user@example.com`)과 비밀번호(최소 8자, 대소문자/숫자/특수문자 포함)를 입력하고 '회원가입' 버튼 클릭, **Then** 계정이 생성되고 "이메일 인증 링크를 발송했습니다" 메시지가 표시됩니다.

2. **Given** 이메일 인증 대기 상태의 사용자, **When** 수신한 이메일의 인증 링크를 클릭, **Then** 계정이 활성화되고 "계정이 활성화되었습니다. 로그인해주세요" 메시지와 함께 로그인 페이지로 리다이렉트됩니다.

3. **Given** 사용자가 회원가입 시도, **When** 이미 가입된 이메일 주소를 입력, **Then** "이미 가입된 이메일입니다" 에러 메시지가 표시되고 가입이 차단됩니다.

4. **Given** 사용자가 비밀번호 입력, **When** 8자 미만 또는 복잡도 요구사항 미충족 비밀번호 입력, **Then** "비밀번호는 최소 8자이며 대소문자, 숫자, 특수문자를 포함해야 합니다" 에러 메시지가 표시됩니다.

5. **Given** 사용자가 이메일 인증 링크를 수신, **When** 링크 발송 후 24시간이 경과한 뒤 클릭, **Then** "인증 링크가 만료되었습니다. 새 링크를 요청해주세요" 메시지가 표시됩니다.

---

### User Story 2 - 이메일/비밀번호 로그인 (Priority: P1)

등록된 사용자가 이메일과 비밀번호를 입력하여 시스템에 로그인하고, 인증 세션을 유지합니다.

**Why this priority**: 회원가입과 동일하게 P1 우선순위입니다. 계정 생성 후 즉시 로그인이 가능해야 사용자 경험이 완성되며, 이 둘은 함께 작동하는 최소 기능 세트입니다.

**Independent Test**: 로그인 페이지에서 등록된 이메일과 비밀번호를 입력하면 인증되어 보호된 페이지(예: 대시보드)에 접근할 수 있습니다. 잘못된 자격 증명은 거부됩니다.

**Acceptance Scenarios**:

1. **Given** 활성화된 계정을 가진 사용자가 로그인 페이지에 접속, **When** 올바른 이메일과 비밀번호를 입력하고 '로그인' 버튼 클릭, **Then** 인증 세션이 생성되고 대시보드 페이지로 리다이렉트됩니다.

2. **Given** 사용자가 로그인 시도, **When** 잘못된 비밀번호를 입력, **Then** "이메일 또는 비밀번호가 올바르지 않습니다" 에러 메시지가 표시됩니다.

3. **Given** 이메일 인증 미완료 사용자가 로그인 시도, **When** 로그인 정보 입력, **Then** "이메일 인증이 필요합니다. 인증 이메일을 확인해주세요" 메시지가 표시되고 로그인이 차단됩니다.

4. **Given** 로그인된 사용자, **When** 브라우저를 닫고 다시 사이트 방문 (세션 만료 전), **Then** 여전히 로그인 상태가 유지되어 대시보드에 접근 가능합니다.

5. **Given** 로그인된 사용자, **When** '로그아웃' 버튼 클릭, **Then** 세션이 종료되고 로그인 페이지로 리다이렉트되며, 보호된 페이지 접근 시 로그인 페이지로 리다이렉트됩니다.

---

### User Story 3 - 비밀번호 재설정 (Priority: P2)

사용자가 비밀번호를 잊었을 때 이메일을 통해 비밀번호 재설정 링크를 받아 새 비밀번호를 설정합니다.

**Why this priority**: 비밀번호 분실은 흔한 사용자 시나리오이지만, 초기 MVP에서는 필수적이지 않습니다. 회원가입/로그인 후 추가할 수 있는 독립적인 기능입니다.

**Independent Test**: "비밀번호 찾기" 링크를 클릭하고 이메일 주소를 입력하면 재설정 링크가 발송됩니다. 링크 클릭 후 새 비밀번호를 설정하면 새 비밀번호로 로그인이 가능합니다.

**Acceptance Scenarios**:

1. **Given** 로그인 페이지의 "비밀번호 찾기" 링크 클릭, **When** 등록된 이메일 주소를 입력하고 제출, **Then** "비밀번호 재설정 링크를 이메일로 발송했습니다" 메시지가 표시됩니다.

2. **Given** 비밀번호 재설정 이메일 수신, **When** 링크를 클릭하여 재설정 페이지 접속, **Then** 새 비밀번호 입력 폼이 표시됩니다.

3. **Given** 비밀번호 재설정 페이지, **When** 유효한 새 비밀번호를 입력하고 제출, **Then** "비밀번호가 변경되었습니다" 메시지와 함께 로그인 페이지로 리다이렉트되며, 새 비밀번호로 로그인 가능합니다.

4. **Given** 비밀번호 재설정 링크, **When** 링크 발송 후 1시간이 경과한 뒤 클릭, **Then** "재설정 링크가 만료되었습니다. 다시 요청해주세요" 메시지가 표시됩니다.

5. **Given** 비밀번호 재설정 요청, **When** 등록되지 않은 이메일 주소 입력, **Then** 보안상 동일한 "비밀번호 재설정 링크를 이메일로 발송했습니다" 메시지를 표시합니다 (이메일 존재 여부를 노출하지 않음).

---

### User Story 4 - 프로필 조회 및 수정 (Priority: P2)

로그인한 사용자가 자신의 프로필 정보(이름, 이메일)를 조회하고 수정할 수 있습니다.

**Why this priority**: 기본 인증 기능 이후에 추가되는 사용자 관리 기능입니다. 초기 MVP에서는 선택적이지만, 사용자가 정보를 업데이트할 수 있어야 완전한 회원관리 시스템이 됩니다.

**Independent Test**: 로그인 후 '내 프로필' 페이지에서 현재 정보를 확인하고, 이름을 수정한 후 저장하면 변경사항이 반영됩니다.

**Acceptance Scenarios**:

1. **Given** 로그인한 사용자가 '내 프로필' 페이지 접속, **When** 페이지 로드, **Then** 현재 이메일, 이름, 가입일이 표시됩니다.

2. **Given** 프로필 페이지에서 이름 필드 수정, **When** 새 이름을 입력하고 '저장' 버튼 클릭, **Then** "프로필이 업데이트되었습니다" 메시지가 표시되고 새 이름이 반영됩니다.

3. **Given** 프로필 페이지에서 이메일 변경 시도, **When** 새 이메일 주소 입력 및 저장, **Then** "새 이메일 주소로 인증 링크를 발송했습니다. 인증 후 변경이 완료됩니다" 메시지가 표시되고, 인증 완료 전까지 기존 이메일이 유지됩니다.

4. **Given** 프로필 페이지, **When** 이름 필드를 빈 값으로 저장 시도, **Then** "이름은 필수 항목입니다" 에러 메시지가 표시됩니다.

---

### User Story 5 - 계정 비활성화 (Priority: P3)

사용자가 자신의 계정을 비활성화하여 로그인을 차단하거나, 영구 삭제를 요청할 수 있습니다.

**Why this priority**: GDPR 등 개인정보 보호 규정 준수를 위해 필요하지만, 초기 출시에서는 선택적입니다. 법적 요구사항이 있는 경우 우선순위를 상향 조정할 수 있습니다.

**Independent Test**: 프로필 설정에서 '계정 비활성화' 버튼을 클릭하고 확인하면 계정이 비활성화되어 로그인이 불가능해집니다.

**Acceptance Scenarios**:

1. **Given** 로그인한 사용자가 '계정 설정' 페이지 접속, **When** '계정 비활성화' 버튼 클릭 및 확인, **Then** 계정이 비활성화되고 로그아웃되며, 이후 로그인 시도 시 "비활성화된 계정입니다" 메시지가 표시됩니다.

2. **Given** 비활성화된 계정의 사용자, **When** 고객 지원에 재활성화 요청, **Then** 관리자가 계정을 재활성화하고 사용자에게 알림 이메일이 발송됩니다.

3. **Given** 로그인한 사용자가 '계정 영구 삭제' 요청, **When** 확인 및 비밀번호 재입력, **Then** 30일 유예기간이 시작되고 "30일 후 계정이 영구 삭제됩니다. 기간 내 로그인하면 취소됩니다" 메시지가 표시됩니다.

---

### Edge Cases

- **동시 회원가입 충돌**: 동일한 이메일로 거의 동시에 회원가입 시도 시 데이터베이스 unique constraint로 중복 방지
- **인증 링크 재사용 방지**: 이메일 인증 또는 비밀번호 재설정 링크를 사용한 후 토큰을 무효화하여 재사용 차단
- **세션 하이재킹 방지**: 세션 토큰을 안전하게 저장하고, HTTPS 필수, httpOnly 쿠키 사용
- **무차별 대입 공격(Brute Force)**: 로그인 실패 시 rate limiting 적용 (5회 실패 시 15분 계정 잠금)
- **SQL Injection 방지**: ORM(Drizzle) 파라미터화 쿼리 사용으로 SQL Injection 차단
- **이메일 열거 공격(Email Enumeration)**: 비밀번호 찾기에서 이메일 존재 여부를 직접 노출하지 않음
- **비밀번호 강도 미달**: 클라이언트/서버 양측에서 비밀번호 복잡도 검증 (Zod 스키마 사용)
- **만료된 토큰 처리**: 인증/재설정 링크 만료 시 명확한 에러 메시지와 재요청 링크 제공
- **네트워크 장애 시 이메일 발송 실패**: 이메일 발송 큐 시스템으로 재시도 로직 구현 (Redis 기반)
- **대량 가입 시도(Bot)**: CAPTCHA 또는 rate limiting으로 자동화된 대량 가입 차단

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 사용자가 이메일 주소와 비밀번호를 입력하여 계정을 생성할 수 있어야 합니다
- **FR-002**: 시스템은 이메일 주소의 유효성을 검증해야 합니다 (RFC 5322 형식 준수)
- **FR-003**: 시스템은 비밀번호가 최소 8자 이상이며 대소문자, 숫자, 특수문자를 포함하는지 검증해야 합니다
- **FR-004**: 시스템은 회원가입 시 중복된 이메일 주소를 거부해야 합니다
- **FR-005**: 시스템은 회원가입 후 이메일 인증 링크를 발송해야 합니다
- **FR-006**: 시스템은 이메일 인증 링크가 24시간 후 만료되어야 합니다
- **FR-007**: 시스템은 이메일 인증 완료 전까지 로그인을 차단해야 합니다
- **FR-008**: 시스템은 사용자가 이메일과 비밀번호로 로그인할 수 있어야 합니다
- **FR-009**: 시스템은 비밀번호를 안전하게 해시하여 저장해야 합니다 (argon2id per research.md decision)
- **FR-010**: 시스템은 로그인 성공 시 Redis-based server session을 생성해야 합니다 (per research.md decision)
- **FR-011**: 시스템은 로그인 실패 시 "이메일 또는 비밀번호가 올바르지 않습니다" 메시지를 표시해야 합니다 (보안상 구체적 이유 노출 금지)
- **FR-012**: 시스템은 사용자가 로그아웃할 수 있어야 하며, 세션을 무효화해야 합니다
- **FR-013**: 시스템은 비밀번호 찾기 기능을 제공하고, 등록된 이메일로 재설정 링크를 발송해야 합니다
- **FR-014**: 시스템은 비밀번호 재설정 링크가 1시간 후 만료되어야 합니다
- **FR-015**: 시스템은 사용자가 자신의 프로필 정보(이름, 이메일)를 조회하고 수정할 수 있어야 합니다
- **FR-016**: 시스템은 이메일 변경 시 새 이메일 주소로 인증 링크를 발송하고, 인증 완료 후 변경을 반영해야 합니다
- **FR-017**: 시스템은 사용자가 계정을 비활성화할 수 있어야 하며, 비활성화 시 로그인을 차단해야 합니다
- **FR-018**: 시스템은 계정 영구 삭제 요청 시 30일 유예기간을 제공해야 합니다
- **FR-019**: 시스템은 로그인 실패 5회 시 해당 계정을 15분간 잠가야 합니다 (Rate Limiting)
- **FR-020**: 시스템은 모든 인증 관련 이벤트(로그인 성공/실패, 비밀번호 변경 등)를 로그로 기록해야 합니다

### Key Entities

- **User**: 사용자 계정 정보를 저장
  - `id` (UUID, PK): 고유 식별자
  - `email` (String, Unique, Not Null): 이메일 주소 (로그인 ID)
  - `password_hash` (String, Not Null): 해시된 비밀번호
  - `name` (String, Nullable): 사용자 이름
  - `email_verified` (Boolean, Default: false): 이메일 인증 여부
  - `is_active` (Boolean, Default: true): 계정 활성화 여부
  - `created_at` (Timestamp): 계정 생성일
  - `updated_at` (Timestamp): 최종 수정일
  - `deleted_at` (Timestamp, Nullable): 계정 삭제 요청일 (Soft Delete)

- **EmailVerificationToken**: 이메일 인증 토큰
  - `id` (UUID, PK): 토큰 고유 식별자
  - `user_id` (UUID, FK → User): 사용자 참조
  - `token` (String, Unique): 인증 토큰 (암호화된 랜덤 문자열)
  - `expires_at` (Timestamp): 만료 시각 (생성 시각 + 24시간)
  - `used_at` (Timestamp, Nullable): 사용 시각 (재사용 방지)
  - `created_at` (Timestamp): 토큰 생성일

- **PasswordResetToken**: 비밀번호 재설정 토큰
  - `id` (UUID, PK): 토큰 고유 식별자
  - `user_id` (UUID, FK → User): 사용자 참조
  - `token` (String, Unique): 재설정 토큰
  - `expires_at` (Timestamp): 만료 시각 (생성 시각 + 1시간)
  - `used_at` (Timestamp, Nullable): 사용 시각
  - `created_at` (Timestamp): 토큰 생성일

- **Session**: 사용자 세션 (better-auth 라이브러리가 관리)
  - better-auth의 기본 세션 스키마 사용
  - 세션 토큰, 만료 시각, 사용자 ID 포함

- **AuthLog**: 인증 이벤트 로그
  - `id` (UUID, PK): 로그 고유 식별자
  - `user_id` (UUID, FK → User, Nullable): 사용자 참조 (로그인 실패 시 null)
  - `event_type` (Enum): 이벤트 유형 (LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT, PASSWORD_CHANGED, EMAIL_VERIFIED 등)
  - `ip_address` (String): 요청 IP 주소
  - `user_agent` (String): 브라우저 User-Agent
  - `metadata` (JSONB, Nullable): 추가 정보 (실패 이유 등)
  - `created_at` (Timestamp): 이벤트 발생 시각

### Constitution Alignment

- **SSOT**: 
  - ✅ 사용자 정보는 `User` 테이블이 SSOT
  - ✅ 기술 스택은 `specs/00-tech-stack.md`를 참조 (better-auth, Drizzle ORM, PostgreSQL, Redis)
  - ⚠️ 세션 관리는 better-auth 라이브러리의 스키마를 SSOT로 사용 (중복 정의 금지)

- **Overrides-Only**: 
  - ✅ better-auth의 기본 설정을 최대한 사용하고, 이메일 인증 필수 등 프로젝트 특화 요구사항만 오버라이드
  - ✅ 비밀번호 복잡도 규칙은 환경 변수로 설정 가능하게 하되, 기본값(최소 8자, 복잡도 요구)을 명시

- **Pinned-Stack**: 
  - ✅ `specs/00-tech-stack.md`에 명시된 기술만 사용:
    - **better-auth** (latest): 인증 라이브러리
    - **Drizzle ORM** (^0.36.0): 타입 안전 데이터베이스 쿼리
    - **PostgreSQL** (16.x): 사용자 데이터 저장
    - **Redis** (7.x): 세션 저장 및 이메일 발송 큐
    - **Zod** (^3.24.0): 입력 검증
    - **react-hook-form** (^7.54.0): 폼 관리
  - 🔄 새로운 의존성 필요 시 기술 스택 문서 업데이트 필요

- **Local-First**: 
  - ✅ Docker Compose로 로컬 PostgreSQL, Redis 실행
  - ✅ 이메일 발송은 로컬 개발 시 Mailhog 또는 콘솔 출력으로 대체 (환경 변수로 전환)
  - ✅ 모든 테스트는 인메모리 DB 또는 로컬 Docker 환경에서 실행 가능

- **Cost-Aware**: 
  - ✅ 이메일 발송은 큐 시스템(Redis)으로 재시도 로직 구현하여 실패 최소화
  - ✅ 세션은 Redis에 캐시하여 데이터베이스 부하 감소
  - ✅ 비밀번호 해시 비용 인자(cost factor)는 보안과 성능의 균형 고려 (bcrypt rounds: 10-12)
  - ⚠️ 이메일 발송 API 사용 시 월간 무료 티어 한도 모니터링 필요 (예: SendGrid 100 emails/day)

- **Boundaries**: 
  - ✅ 명확한 모듈 분리:
    - **Auth Module (NestJS)**: 회원가입, 로그인, 로그아웃, 세션 관리
    - **User Module (NestJS)**: 프로필 조회/수정, 계정 비활성화
    - **Email Module (NestJS)**: 이메일 발송 (인증, 재설정 링크)
    - **Auth UI (Next.js)**: 로그인/회원가입 폼 컴포넌트
  - ✅ 모듈 간 통신은 명시적 서비스 인터페이스 사용
  - ✅ 순환 의존성 금지 (User → Auth 의존 금지)

- **Type-Safety**: 
  - ✅ TypeScript strict mode 활성화
  - ✅ Drizzle ORM으로 데이터베이스 스키마 타입 자동 생성
  - ✅ Zod 스키마로 API 요청/응답 타입 검증
  - ✅ better-auth의 TypeScript 타입 정의 활용
  - ✅ `any` 타입 사용 금지 (예외 시 정당화 주석 필수)

- **Spec-Before-Code**: 
  - ✅ 이 문서 자체가 구현 전 명세를 충족함
  - ✅ `plan.md` 및 `tasks.md` 작성 후 구현 시작

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 사용자가 회원가입부터 이메일 인증 완료까지 3분 이내에 완료할 수 있어야 합니다
- **SC-002**: 로그인 요청의 95%가 500ms 이내에 응답되어야 합니다 (데이터베이스 쿼리 + 세션 생성)
- **SC-003**: 비밀번호 재설정 플로우의 완료율이 80% 이상이어야 합니다 (링크 클릭 → 재설정 완료)
- **SC-004**: 이메일 인증 링크의 전달률이 95% 이상이어야 합니다 (스팸 필터 회피)
- **SC-005**: 무차별 대입 공격(Brute Force) 차단율 100% (5회 실패 시 계정 잠금 작동)
- **SC-006**: 시스템이 1,000명의 동시 로그인 사용자를 처리할 수 있어야 합니다 (부하 테스트)
- **SC-007**: 모든 비밀번호가 안전하게 해시되어 저장되며, 평문 비밀번호 노출 사례 0건
- **SC-008**: E2E 테스트(Playwright)로 모든 주요 사용자 플로우(P1, P2)가 자동 검증되어야 합니다
- **SC-009**: 회원가입 폼의 검증 에러가 실시간으로 표시되어 사용자 경험을 개선해야 합니다 (react-hook-form 활용)
- **SC-010**: 인증 관련 보안 이벤트(로그인 실패, 비밀번호 변경)의 100%가 로그로 기록되어야 합니다

---

**Related Documents**:
- [프로젝트 헌법](../../.specify/memory/constitution.md)
- [기술 스택 명세서](../00-tech-stack.md)
- [구현 계획](./plan.md) *(작성 예정)*
- [작업 목록](./tasks.md) *(작성 예정)*

